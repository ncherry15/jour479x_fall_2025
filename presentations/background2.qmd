---
title: "refining and viisuals"
format: html
---

## Research Question
Do early-down offensive efficiency and third-down execution contribute differently to winning NFL games?

Early-down EPA is more stable across games, while third-down EPA is highly variable and may reflect situational execution rather than repeatable skill.
## Data Sources
- nflfastr library 
- play by play data
- game schedules
```{r}
library(nflfastR)
library(tidyverse)
```
## Load regular season PBP for 2021–2024
```{r}
pbp <- load_pbp(2021:2024)
```
##Update
My core question remains the same, but I decided to expand it with a direct comparison. Rather than asking whether all offensive play patterns predict winning, I am now explicitly separating:early-down EPA from third-down success.
##Load Offensive Data
```{r}
off_plays <- pbp |> 
  filter(!is.na(epa),
         down %in% c(1, 2,3),
         play_type %in% c("run", "pass"))
```
##Load Game Outcomes
```{r}
seasons <- 2021:2024
game_results <- nflreadr::load_schedules(seasons)

game_results <- game_results %>%
  mutate(
    home_score = as.integer(home_score),
    away_score = as.integer(away_score),
    winner = case_when(
      home_score > away_score ~ home_team,
      away_score > home_score ~ away_team,
      home_score == away_score ~ NA_character_
    )
  )
```
##Merge Dataframes
```{r}
off_plays <- off_plays %>%
  left_join(
    game_results %>% select(game_id, winner),
    by = "game_id",
    
off_plays <- off_plays %>%
  mutate(posteam_won = if_else(posteam == winner, 1, 0))
  )
```
##Epa/down
```{r}
epa_by_down <- off_plays |> 
  group_by(game_id, posteam, down, winner) |> 
  summarise(down_epa = mean(epa), .groups = "drop")

early_vs_late <- epa_by_down |> 
  pivot_wider(names_from = down, values_from = down_epa,
              names_prefix = "down_"
              )
```
##Early findings
Early-own EPA is much more subject to change than third-down EPA which makes sense as early downs happen frequently, giving teams more opportunities to succeed or fail. I did not expect to see as much variability in the early downs' EPA. Off of first glances, I also see that I could be right,the winners tend to have positive early-down EPA. This early analysis definitely encourages me to look at third down residuals how you suggested. One of my biggest concerns currently is modeling the relationship between early-down EPA and winning while also isolating third-down over-performance defined as a team gaining more EPA than expected (big plays on third down can often result in game-winning drives.) I'm also debating how big of a role the home-away data is going to play in my analysis. Could home team momentum contribute to those "early downs?" If the teams moves the chains, the crowd will be hype is this momentum carrying them to a win or is it really their offensive efficiency. Third down plays also occur much less often but have a bigger impact so comparing their averages may not be entirely accurate. 
##Early Strategy
To separate sustainable offensive efficiency from high-leverage swings, I think I can use a two-step modeling strategy:

1.Early-down EPA -> Probability of Winning  
  This estimates how much consistent drive efficiency contributes to winning (closer to my original scope)

2. Early-down EPA + Third-down Metrics -> Probability of Winning  
  Third-down performance will be represented using:
- third-down EPA residuals (overperformance)
- third-down success metric
Comparing these two models will reveal whether third-down overperformance adds meaningful predictive power or simply introduces noise.
#Adding Postteam Won
```{r}
off_plays <- off_plays %>%
  mutate(
    posteam_won = case_when(
      posteam == winner ~ 1,
      posteam != winner ~ 0,
      TRUE ~ NA_real_
    )
  )
```
#Separating Early Downs
```{r}
early_downs <- off_plays |>
filter(down %in% c(1, 2))

third_downs <- off_plays |>
filter(down == 3)
```
#Early Down EPA vs. Winning
```{r}
early_epa_game <- early_downs |>
group_by(game_id, posteam, posteam_won) |>
summarise(
early_epa = mean(epa),
early_plays = n(),
.groups = "drop"
)
```
#Results
Teams that win tend to have positive early-down EPA while losing teams cluster closer to zero or negative values. This supports the idea that early-down efficiency reflects sustainable offensive strength rather than randomness. There are few exceptions to this but I can evaluate this more closer later.
#Third-Down Conversion Rate
```{r}
third_down_game <- third_downs |>
group_by(game_id, posteam, posteam_won) |>
summarise(
third_conv_rate = mean(first_down == 1, na.rm = TRUE),
third_plays = n(),
.groups = "drop"
)
```
EPA on third down is noisy and play-size dependent while the conversion rate directly captures whether the offense accomplished its goal. I think now this will be easier to interpret and explain visually.
#Starting the Modeling Process
```{r}
game_level <- early_epa_game |>
left_join(third_down_game, by = c("game_id", "posteam", "posteam_won"))
```
Now this will allow me to conduct my two models: winning ~ early-down EPA, and winning ~ early-down EPA + third-down conversion rate.
#Visualizations
```{r}
ggplot(game_level, aes(x = early_epa, y = third_conv_rate, color = factor(posteam_won))) +
geom_point(alpha = 0.6) +
labs(
x = "Early-Down EPA",
y = "Third-Down Conversion Rate",
color = "Won Game"
)
```
This plot shows that teams with higher early-down EPA and higher third-down conversion rates are more likely to win games. Wins (blue points) tend to cluster in the upper-right area, while losses (red points) are more common in the lower-left. There’s overlap, but early-down efficiency clearly separates winners better than third-down success alone.
#Other Potential Visualizations
Early-Down EPA vs Win Probability
- Boxplot
- Show the separation between winners and losers
Third-Down Conversion Rate Distribution
- Side by side boxplots
- Analyzing is winners consistently convert more often
#Some Roadblocks
- Third-down sample size
- Some of the EPAs could reflect team quality rather than actual in-game execution
#New Questions
- Should I consider a minimum play threshold to accommodate the third-down sample size?
- Do you think I need to incorporate the home/away effect because that definitely could shift early-down EPA?